<template>
    <div class="relative" v-clickaway="hideList">
        <SearchInput :aria-expanded="isShowing" v-model="search" :usePencil="true" :placeholder="'Search country...'"
            @keydown.down="event => $refs['listPicker'].incrementFocus(event)"
            @keydown.up="event => $refs['listPicker'].decrementFocus(event)"
            @keydown.enter="event => $refs['listPicker'].selectCurrentItem()" @onFocus="showList" @onClick="showList"
            @onCloseClick="onCloseClick">
            <template v-slot:icon>
                <PinIcon class="h-6 w-6 absolute inset-0 m-4" />
            </template>
        </SearchInput>

        <transition leave-active-class="transition ease-in duration-100" leave-from-class="opacity-100"
            leave-to-class="opacity-0">
            <div v-if="isShowing" class="absolute z-10 mt-1 w-full rounded-md shadow-lg" :class="{
                'bg-white': filteredCountries.length > 0,
                'bg-gray-100': !filteredCountries.length,
            }">
                <div v-if="filteredCountries.length === 0" class="text-gray-500 text-center p-4 shadow-lg">
                    No countries found
                </div>
                <ListPicker ref="listPicker" v-else :items="filteredCountries" v-slot="{ item }"
                    @selectItem="onSelectCountry">
                    <LocationSearchItem :id="item" :title="$t(`COUNTRY_${item}`)" :isSelected="item === modelValue" />
                </ListPicker>
            </div>
        </transition>
    </div>
</template>

<script setup>
import LocationSearchItem from './LocationSearchItem.vue'
import PinIcon from './PinIcon.vue'
import { findCountries } from './countries'
import SearchInput from '@/components/forms/input/SearchInput'
import ListPicker from '@/components/forms/ListPicker'
import { useI18n } from 'vue-i18n'

const { t, te } = useI18n()
const props = defineProps({
    modelValue: String,
})

const emit = defineEmits(['update:modelValue'])


const isShowing = ref(false)
const country = useCountry()
const search = ref(t(`COUNTRY_${country.value}`))
if (props.modelValue && te(`COUNTRY_${props.modelValue}`)) {
    search.value = t(`COUNTRY_${props.modelValue}`)
}

const filteredCountries = computed(() => findCountries(search.value))

watch(search, () => {
    if (props.modelValue && search.value !== t(`COUNTRY_${country.value}`)) {
        emit('update:modelValue', '')
    }
})

function showList() {
    isShowing.value = true
}
function hideList() {
    isShowing.value = false
}

async function onSelectCountry(code) {
    country.value = code
    search.value = t(`COUNTRY_${code}`)
    emit('update:modelValue', code)
    isShowing.value = false
}

function onCloseClick() {
    search.value = ''
    emit('update:modelValue', '')
}

</script>
